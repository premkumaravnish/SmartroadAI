'use client'

import { useState, useEffect, useCallback } from 'react'
import { useRouter } from 'next/navigation'
import dynamic from 'next/dynamic'
import axios from 'axios'

// Dynamically import maps to avoid SSR issues
const PotholeAlertMap = dynamic(() => import('../../components/PotholeAlertMap'), { ssr: false })
const RouteMap = dynamic(() => import('../../components/RouteMap'), { ssr: false })

export default function NavigatePage() {
  const router = useRouter()
  const [location, setLocation] = useState(null)
  const [watchId, setWatchId] = useState(null)
  const [isTracking, setIsTracking] = useState(false)
  const [reports, setReports] = useState([])
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState(null)
  const [alertRadius, setAlertRadius] = useState(500)
  const [showAlertZones, setShowAlertZones] = useState(true)
  const [soundEnabled, setSoundEnabled] = useState(true)
  const [lastAlertTime, setLastAlertTime] = useState({})
  
  // Route planning states
  const [useRouteMode, setUseRouteMode] = useState(false)
  const [showRouteModal, setShowRouteModal] = useState(false)
  const [showHowToUse, setShowHowToUse] = useState(false)
  const [showRouteAnalysis, setShowRouteAnalysis] = useState(true)
  const [startInput, setStartInput] = useState('')
  const [endInput, setEndInput] = useState('')
  const [startLocation, setStartLocation] = useState(null)
  const [endLocation, setEndLocation] = useState(null)
  const [searching, setSearching] = useState(false)
  const [locationSuggestions, setLocationSuggestions] = useState({ start: [], end: [] })
  const [stats, setStats] = useState({
    totalDistance: 0,
    potholesPassed: 0,
    alertsShown: 0
  })

  // Fetch pothole reports from backend
  useEffect(() => {
    const fetchReports = async () => {
      setLoading(true)
      try {
        const response = await axios.get('http://localhost:5000/reports')
        setReports(response.data || [])
        setError(null)
      } catch (err) {
        // If backend is not available, try to load from local file
        try {
          const localResponse = await fetch('/reports.json')
          if (localResponse.ok) {
            const data = await localResponse.json()
            setReports(data || [])
            setError(null)
          } else {
            setError('Could not load pothole reports')
          }
        } catch (localErr) {
          setError('Could not connect to backend')
          console.error('Error fetching reports:', err, localErr)
        }
      } finally {
        setLoading(false)
      }
    }

    fetchReports()
    // Refresh every 30 seconds
    const interval = setInterval(fetchReports, 30000)
    return () => clearInterval(interval)
  }, [])

  // Play alert sound
  const playAlertSound = useCallback(() => {
    if (!soundEnabled) return
    
    // Create audio context for alert beep
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)()
      const oscillator = audioContext.createOscillator()
      const gainNode = audioContext.createGain()
      
      oscillator.connect(gainNode)
      gainNode.connect(audioContext.destination)
      
      oscillator.frequency.value = 800
      oscillator.type = 'sine'
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime)
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5)
      
      oscillator.start(audioContext.currentTime)
      oscillator.stop(audioContext.currentTime + 0.5)
    } catch (err) {
      console.error('Could not play sound:', err)
    }
  }, [soundEnabled])

  // Start live location tracking
  const startTracking = useCallback(() => {
    if (!navigator.geolocation) {
      setError('Geolocation is not supported by your browser')
      return
    }

    const id = navigator.geolocation.watchPosition(
      (position) => {
        const newLocation = {
          lat: position.coords.latitude,
          lon: position.coords.longitude,
          accuracy: position.coords.accuracy,
          speed: position.coords.speed,
          heading: position.coords.heading
        }
        setLocation(newLocation)
        setError(null)
        setIsTracking(true)

        // Check for nearby potholes and play sound for new alerts
        checkNearbyPotholes(newLocation)
      },
      (err) => {
        setError(`Location error: ${err.message}`)
        setIsTracking(false)
      },
      {
        enableHighAccuracy: true,
        timeout: 5000,
        maximumAge: 0
      }
    )

    setWatchId(id)
  }, [])

  // Stop tracking
  const stopTracking = useCallback(() => {
    if (watchId !== null) {
      navigator.geolocation.clearWatch(watchId)
      setWatchId(null)
      setIsTracking(false)
    }
  }, [watchId])

  // Check for nearby potholes
  const checkNearbyPotholes = useCallback((currentLocation) => {
    if (!currentLocation || !reports.length) return

    const now = Date.now()
    let newAlerts = 0

    reports.forEach((report) => {
      const distance = calculateDistance(
        currentLocation.lat,
        currentLocation.lon,
        report.lat,
        report.lon
      )

      // Alert if within radius and not alerted recently (cooldown 60 seconds)
      if (distance <= alertRadius) {
        const lastAlert = lastAlertTime[report.id] || 0
        if (now - lastAlert > 60000) {
          playAlertSound()
          setLastAlertTime(prev => ({ ...prev, [report.id]: now }))
          newAlerts++
        }
      }
    })

    if (newAlerts > 0) {
      setStats(prev => ({
        ...prev,
        alertsShown: prev.alertsShown + newAlerts
      }))
    }
  }, [reports, alertRadius, lastAlertTime, playAlertSound])

  // Calculate distance between two coordinates
  const calculateDistance = (lat1, lon1, lat2, lon2) => {
    const R = 6371e3
    const œÜ1 = lat1 * Math.PI / 180
    const œÜ2 = lat2 * Math.PI / 180
    const ŒîœÜ = (lat2 - lat1) * Math.PI / 180
    const ŒîŒª = (lon2 - lon1) * Math.PI / 180

    const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
              Math.cos(œÜ1) * Math.cos(œÜ2) *
              Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2)
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))

    return R * c
  }

  // Get current position once
  const getCurrentLocation = () => {
    if (!navigator.geolocation) {
      setError('Geolocation is not supported')
      return
    }

    navigator.geolocation.getCurrentPosition(
      (position) => {
        setLocation({
          lat: position.coords.latitude,
          lon: position.coords.longitude,
          accuracy: position.coords.accuracy
        })
        setError(null)
      },
      (err) => {
        setError(`Location error: ${err.message}`)
      }
    )
  }

  // Get current location for route start
  const getCurrentLocationForRoute = () => {
    if (!navigator.geolocation) {
      setError('Geolocation is not supported')
      return
    }

    navigator.geolocation.getCurrentPosition(
      (position) => {
        const loc = {
          lat: position.coords.latitude,
          lon: position.coords.longitude,
          name: 'Current Location'
        }
        setStartLocation(loc)
        setStartInput('Current Location')
        setLocationSuggestions(prev => ({ ...prev, start: [] }))
        setError(null)
      },
      (err) => {
        setError(`Location error: ${err.message}`)
      }
    )
  }

  // Search location using OpenStreetMap Nominatim API
  const searchLocation = async (query, type) => {
    if (!query || query.length < 3) {
      setLocationSuggestions(prev => ({ ...prev, [type]: [] }))
      return
    }

    setSearching(true)
    try {
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`
      )
      const data = await response.json()
      
      const suggestions = data.map(item => ({
        name: item.display_name.split(',')[0],
        lat: parseFloat(item.lat),
        lon: parseFloat(item.lon),
        fullName: item.display_name
      }))

      setLocationSuggestions(prev => ({ ...prev, [type]: suggestions }))
    } catch (err) {
      console.error('Search error:', err)
    } finally {
      setSearching(false)
    }
  }

  // Select location from suggestions
  const selectLocation = (location, type) => {
    if (type === 'start') {
      setStartLocation(location)
      setStartInput(location.name)
      setLocationSuggestions(prev => ({ ...prev, start: [] }))
    } else {
      setEndLocation(location)
      setEndInput(location.name)
      setLocationSuggestions(prev => ({ ...prev, end: [] }))
    }
  }

  // Apply route and close modal
  const applyRoute = () => {
    if (startLocation && endLocation) {
      setUseRouteMode(true)
      setShowRouteModal(false)
    }
  }

  // Clear route
  const clearRoute = () => {
    setStartLocation(null)
    setEndLocation(null)
    setStartInput('')
    setEndInput('')
    setUseRouteMode(false)
    setLocationSuggestions({ start: [], end: [] })
  }

  // Toggle tracking
  const toggleTracking = () => {
    if (isTracking) {
      stopTracking()
    } else {
      startTracking()
    }
  }

  return (
    <div style={{ 
      minHeight: '100vh', 
      backgroundColor: '#0f172a',
      color: '#FFF',
      display: 'flex',
      flexDirection: 'column',
      backgroundImage: `
        radial-gradient(ellipse 80% 50% at 20% 0%, rgba(59, 130, 246, 0.08) 0%, transparent 60%),
        radial-gradient(ellipse 60% 40% at 80% 100%, rgba(6, 182, 212, 0.06) 0%, transparent 60%)
      `
    }}>
      {/* ===== NAVBAR & CONTROLS SECTION ===== */}
      {/* Header */}
      <div style={{
        backgroundColor: 'rgba(15, 23, 42, 0.85)',
        backdropFilter: 'blur(12px)',
        padding: '20px',
        borderBottom: '1px solid rgba(6, 182, 212, 0.1)',
        position: 'fixed',
        top: 70,
        left: 0,
        right: 0,
        zIndex: 997
      }}>
        <div style={{ maxWidth: '1400px', margin: '0 auto' }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '15px' }}>
            <div>
              <h1 style={{ margin: '0 0 5px 0', fontSize: '24px', fontWeight: 'bold' }}>
                üó∫Ô∏è Pothole Navigation & Route Planning
              </h1>
              <p style={{ margin: 0, color: '#AAA', fontSize: '14px' }}>
                {useRouteMode ? 'Showing potholes on your planned route' : 'Real-time GPS tracking with pothole alerts'}
              </p>
            </div>
            
            <div style={{ display: 'flex', gap: '10px', alignItems: 'center', flexWrap: 'wrap', width: '100%', justifyContent: 'flex-end' }}>
              <button
                onClick={() => setShowHowToUse(true)}
                style={{
                  padding: '12px 20px',
                  backgroundColor: 'rgba(59, 130, 246, 0.1)',
                  color: '#60A5FA',
                  border: '1px solid rgba(59, 130, 246, 0.3)',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontSize: '14px',
                  fontWeight: '500',
                  transition: 'all 0.2s',
                  whiteSpace: 'nowrap'
                }}
                onMouseOver={(e) => {
                  e.target.style.backgroundColor = 'rgba(59, 130, 246, 0.2)';
                  e.target.style.borderColor = 'rgba(59, 130, 246, 0.5)';
                }}
                onMouseOut={(e) => {
                  e.target.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
                  e.target.style.borderColor = 'rgba(59, 130, 246, 0.3)';
                }}
              >
                ‚ùì How to Use
              </button>

              <button
                onClick={() => router.push('/')}
                style={{
                  padding: '12px 20px',
                  backgroundColor: 'rgba(148, 163, 184, 0.1)',
                  color: '#CBD5E1',
                  border: '1px solid rgba(148, 163, 184, 0.2)',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontSize: '14px',
                  fontWeight: '500',
                  transition: 'all 0.2s',
                  whiteSpace: 'nowrap'
                }}
                onMouseOver={(e) => {
                  e.target.style.backgroundColor = 'rgba(148, 163, 184, 0.15)';
                }}
                onMouseOut={(e) => {
                  e.target.style.backgroundColor = 'rgba(148, 163, 184, 0.1)';
                }}
              >
                ‚Üê Back
              </button>

              {/* Route Planning Button - Google Maps style */}
              <button
                onClick={() => setShowRouteModal(true)}
                style={{
                  padding: '14px 32px',
                  background: 'linear-gradient(135deg, #06B6D4 0%, #0EA5E9 50%, #3B82F6 100%)',
                  color: '#FFF',
                  border: 'none',
                  borderRadius: '10px',
                  cursor: 'pointer',
                  fontSize: '16px',
                  fontWeight: 'bold',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '10px',
                  boxShadow: '0 8px 24px rgba(6, 182, 212, 0.4)',
                  transition: 'all 0.3s ease',
                  whiteSpace: 'nowrap'
                }}
                onMouseOver={(e) => {
                  e.target.style.transform = 'translateY(-3px)';
                  e.target.style.boxShadow = '0 12px 32px rgba(6, 182, 212, 0.6)';
                  e.target.style.background = 'linear-gradient(135deg, #0EA5E9 0%, #3B82F6 50%, #06B6D4 100%)';
                }}
                onMouseOut={(e) => {
                  e.target.style.transform = 'translateY(0)';
                  e.target.style.boxShadow = '0 8px 24px rgba(6, 182, 212, 0.4)';
                  e.target.style.background = 'linear-gradient(135deg, #06B6D4 0%, #0EA5E9 50%, #3B82F6 100%)';
                }}
              >
                <span style={{ fontSize: '18px' }}>üöó</span> Plan Your Route
              </button>

              {useRouteMode && (
                <button
                  onClick={clearRoute}
                  style={{
                    padding: '12px 20px',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    color: '#F87171',
                    border: '1px solid rgba(239, 68, 68, 0.3)',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontSize: '14px',
                    fontWeight: '500',
                    transition: 'all 0.2s',
                    whiteSpace: 'nowrap'
                  }}
                  onMouseOver={(e) => {
                    e.target.style.backgroundColor = 'rgba(239, 68, 68, 0.15)';
                    e.target.style.borderColor = 'rgba(239, 68, 68, 0.5)';
                  }}
                  onMouseOut={(e) => {
                    e.target.style.backgroundColor = 'rgba(239, 68, 68, 0.1)';
                    e.target.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                  }}
                >
                  ‚úï Clear Route
                </button>
              )}
            </div>
          </div>

          {/* Route Summary Bar */}
          {useRouteMode && startLocation && endLocation && (
            <div style={{
              backgroundColor: 'rgba(6, 182, 212, 0.08)',
              padding: '15px 20px',
              borderRadius: '8px',
              border: '1px solid rgba(6, 182, 212, 0.2)',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center',
              flexWrap: 'wrap',
              gap: '15px',
              marginTop: '15px'
            }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                <div>
                  <span style={{ color: '#94A3B8', fontSize: '12px' }}>From:</span>
                  <div style={{ fontWeight: 'bold', fontSize: '14px', color: '#E2E8F0' }}>{startInput}</div>
                </div>
                <span style={{ color: '#06B6D4', fontSize: '20px' }}>‚Üí</span>
                <div>
                  <span style={{ color: '#94A3B8', fontSize: '12px' }}>To:</span>
                  <div style={{ fontWeight: 'bold', fontSize: '14px', color: '#E2E8F0' }}>{endInput}</div>
                </div>
              </div>
              <button
                onClick={() => setShowRouteModal(true)}
                style={{
                  padding: '8px 16px',
                  backgroundColor: 'rgba(59, 130, 246, 0.1)',
                  color: '#60A5FA',
                  border: '1px solid rgba(59, 130, 246, 0.3)',
                  borderRadius: '8px',
                  cursor: 'pointer',
                  fontSize: '13px',
                  fontWeight: '500',
                  transition: 'all 0.2s'
                }}
                onMouseOver={(e) => {
                  e.target.style.backgroundColor = 'rgba(59, 130, 246, 0.15)';
                }}
                onMouseOut={(e) => {
                  e.target.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
                }}
              >
                ‚úèÔ∏è Edit Route
              </button>
            </div>
          )}
        </div>
      </div>

      {/* "How to Use" Modal */}
      {showHowToUse && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0, 0, 0, 0.7)',
          zIndex: 9998,
          display: 'flex',
          justifyContent: 'center',
          alignItems: 'center',
          padding: '20px',
          backdropFilter: 'blur(5px)'
        }}
        onClick={() => setShowHowToUse(false)}
        >
          <div style={{
            backgroundColor: 'rgba(30, 41, 59, 0.95)',
            backdropFilter: 'blur(12px)',
            borderRadius: '16px',
            maxWidth: '500px',
            width: '100%',
            padding: '32px',
            boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
            border: '1px solid rgba(6, 182, 212, 0.2)'
          }}
          onClick={(e) => e.stopPropagation()}
          >
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
              <h2 style={{ margin: 0, fontSize: '24px', fontWeight: 'bold', color: '#06B6D4' }}>
                üöó How to Use
              </h2>
              <button
                onClick={() => setShowHowToUse(false)}
                style={{
                  backgroundColor: 'transparent',
                  border: 'none',
                  color: '#94A3B8',
                  fontSize: '28px',
                  cursor: 'pointer',
                  padding: '0',
                  width: '36px',
                  height: '36px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  borderRadius: '50%',
                  transition: 'all 0.2s'
                }}
                onMouseOver={(e) => {
                  e.target.style.backgroundColor = 'rgba(148, 163, 184, 0.1)';
                  e.target.style.color = '#E2E8F0';
                }}
                onMouseOut={(e) => {
                  e.target.style.backgroundColor = 'transparent';
                  e.target.style.color = '#94A3B8';
                }}
              >
                ‚úï
              </button>
            </div>
            
            <div style={{ fontSize: '15px', lineHeight: '1.8', color: '#DDD', marginBottom: '24px' }}>
              <div style={{ marginBottom: '16px' }}>
                <strong style={{ color: '#4CAF50', fontSize: '16px' }}>Live Tracking Mode:</strong>
                <ul style={{ margin: '8px 0 0 0', paddingLeft: '20px' }}>
                  <li>Click <strong>"Get Location"</strong> to find your current position</li>
                  <li>Click <strong>"Start Live Tracking"</strong> to enable real-time navigation</li>
                  <li>You'll get instant alerts when potholes are near</li>
                  <li>Adjust alert radius to customize warning distance</li>
                </ul>
              </div>

              <div>
                <strong style={{ color: '#60A5FA', fontSize: '16px' }}>Plan Route Mode:</strong>
                <ul style={{ margin: '8px 0 0 0', paddingLeft: '20px' }}>
                  <li>Click <strong>"Plan Your Route"</strong> to open the route planner</li>
                  <li>Enter your starting location or use current location</li>
                  <li>Search and select your destination</li>
                  <li>Click <strong>"Show Route with Potholes"</strong> to visualize</li>
                  <li>All potholes along your route will be highlighted</li>
                </ul>
              </div>
            </div>

            <button
              onClick={() => setShowHowToUse(false)}
              style={{
                width: '100%',
                padding: '14px',
                background: 'linear-gradient(135deg, rgb(59, 130, 246), rgb(6, 182, 212))',
                color: '#FFF',
                border: 'none',
                borderRadius: '8px',
                cursor: 'pointer',
                fontSize: '16px',
                fontWeight: 'bold',
                transition: 'all 0.2s'
              }}
              onMouseOver={(e) => {
                e.target.style.transform = 'translateY(-2px)';
                e.target.style.boxShadow = '0 8px 20px rgba(59, 130, 246, 0.3)';
              }}
              onMouseOut={(e) => {
                e.target.style.transform = 'translateY(0)';
                e.target.style.boxShadow = 'none';
              }}
            >
              ‚úì Got It!
            </button>
          </div>
        </div>
      )}

      {/* Route Planning Modal - Full screen overlay */}
      {showRouteModal && (
        <div style={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          backgroundColor: 'rgba(0, 0, 0, 0.7)',
          zIndex: 9999,
          display: 'flex',
          justifyContent: 'center',
          alignItems: 'center',
          padding: '20px',
          backdropFilter: 'blur(5px)'
        }}
        onClick={() => setShowRouteModal(false)}
        >
          <div style={{
            backgroundColor: 'rgba(30, 41, 59, 0.95)',
            backdropFilter: 'blur(12px)',
            borderRadius: '16px',
            maxWidth: '600px',
            width: '100%',
            maxHeight: '90vh',
            overflow: 'auto',
            boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
            border: '1px solid rgba(6, 182, 212, 0.2)'
          }}
          onClick={(e) => e.stopPropagation()}
          >
            {/* Modal Header */}
            <div style={{
              padding: '24px',
              borderBottom: '1px solid rgba(6, 182, 212, 0.1)',
              display: 'flex',
              justifyContent: 'space-between',
              alignItems: 'center'
            }}>
              <div>
                <h2 style={{ margin: '0 0 5px 0', fontSize: '22px', fontWeight: 'bold', color: '#06B6D4' }}>
                  üó∫Ô∏è Plan Your Route
                </h2>
                <p style={{ margin: 0, fontSize: '13px', color: '#94A3B8' }}>
                  Enter start and destination to see potholes on your route
                </p>
              </div>
              <button
                onClick={() => setShowRouteModal(false)}
                style={{
                  backgroundColor: 'transparent',
                  border: 'none',
                  color: '#94A3B8',
                  fontSize: '28px',
                  cursor: 'pointer',
                  padding: '0',
                  width: '36px',
                  height: '36px',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  borderRadius: '50%',
                  transition: 'all 0.2s'
                }}
                onMouseOver={(e) => {
                  e.target.style.backgroundColor = 'rgba(148, 163, 184, 0.1)';
                  e.target.style.color = '#E2E8F0';
                }}
                onMouseOut={(e) => {
                  e.target.style.backgroundColor = 'transparent';
                  e.target.style.color = '#94A3B8';
                }}
              >
                ‚úï
              </button>
            </div>

            {/* Modal Body */}
            <div style={{ padding: '24px' }}>
              {/* Start Location Input */}
              <div style={{ marginBottom: '20px' }}>
                <label style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px',
                  marginBottom: '10px',
                  fontSize: '14px',
                  fontWeight: 'bold',
                  color: '#06B6D4'
                }}>
                  <span style={{ fontSize: '20px' }}>üü¢</span> Your Location
                </label>
                
                <div style={{ position: 'relative' }}>
                  <input
                    type="text"
                    value={startInput}
                    onChange={(e) => {
                      setStartInput(e.target.value)
                      searchLocation(e.target.value, 'start')
                    }}
                    placeholder="Choose starting point or click below to use current location"
                    style={{
                      width: '100%',
                      padding: '14px 16px',
                      backgroundColor: 'rgba(6, 182, 212, 0.05)',
                      color: '#E2E8F0',
                      border: '1px solid rgba(6, 182, 212, 0.3)',
                      borderRadius: '8px',
                      fontSize: '15px',
                      boxSizing: 'border-box',
                      marginBottom: '10px',
                      outline: 'none',
                      transition: 'all 0.2s'
                    }}
                    onFocus={(e) => {
                      e.target.style.borderColor = 'rgba(6, 182, 212, 0.6)';
                      e.target.style.backgroundColor = 'rgba(6, 182, 212, 0.1)';
                    }}
                    onBlur={(e) => {
                      e.target.style.borderColor = 'rgba(6, 182, 212, 0.3)';
                      e.target.style.backgroundColor = 'rgba(6, 182, 212, 0.05)';
                    }}
                  />

                    {locationSuggestions.start.length > 0 && (
                    <div style={{
                      position: 'absolute',
                      top: '56px',
                      left: 0,
                      right: 0,
                      backgroundColor: 'rgba(30, 41, 59, 0.95)',
                      border: '1px solid rgba(6, 182, 212, 0.3)',
                      borderRadius: '8px',
                      marginTop: '4px',
                      zIndex: 10000,
                      maxHeight: '200px',
                      overflowY: 'auto',
                      boxShadow: '0 8px 20px rgba(0,0,0,0.3)'
                    }}>
                      {locationSuggestions.start.map((loc, idx) => (
                        <div
                          key={idx}
                          onClick={() => selectLocation(loc, 'start')}
                          style={{
                            padding: '12px 16px',
                            borderBottom: idx < locationSuggestions.start.length - 1 ? '1px solid rgba(148, 163, 184, 0.1)' : 'none',
                            cursor: 'pointer',
                            fontSize: '14px',
                            transition: 'background 0.2s'
                          }}
                          onMouseOver={(e) => e.target.style.backgroundColor = 'rgba(59, 130, 246, 0.1)'}
                          onMouseOut={(e) => e.target.style.backgroundColor = '#0A0A0A'}
                        >
                          <div style={{ fontWeight: 'bold', marginBottom: '2px' }}>üìç {loc.name}</div>
                          <div style={{ fontSize: '12px', color: '#AAA' }}>{loc.fullName}</div>
                        </div>
                      ))}
                    </div>
                    )}
                </div>

                <button
                  onClick={() => getCurrentLocationForRoute()}
                  style={{
                    width: '100%',
                    padding: '12px',
                    backgroundColor: '#2E7D32',
                    color: '#FFF',
                    border: 'none',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontSize: '14px',
                    fontWeight: 'bold',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '8px',
                    transition: 'background 0.2s'
                  }}
                  onMouseOver={(e) => e.target.style.backgroundColor = '#1B5E20'}
                  onMouseOut={(e) => e.target.style.backgroundColor = '#2E7D32'}
                >
                  üìç Use My Current Location
                </button>
              </div>

              {/* Destination Input */}
              <div style={{ marginBottom: '24px' }}>
                <label style={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px',
                  marginBottom: '10px',
                  fontSize: '14px',
                  fontWeight: 'bold',
                  color: '#60A5FA'
                }}>
                  <span style={{ fontSize: '20px' }}>üîµ</span> Destination
                </label>
                
                <div style={{ position: 'relative' }}>
                  <input
                    type="text"
                    value={endInput}
                    onChange={(e) => {
                      setEndInput(e.target.value)
                      searchLocation(e.target.value, 'end')
                    }}
                    placeholder="Where do you want to go?"
                    style={{
                      width: '100%',
                      padding: '14px 16px',
                      backgroundColor: 'rgba(59, 130, 246, 0.05)',
                      color: '#E2E8F0',
                      border: '1px solid rgba(59, 130, 246, 0.3)',
                      borderRadius: '8px',
                      fontSize: '15px',
                      boxSizing: 'border-box',
                      outline: 'none',
                      transition: 'all 0.2s'
                    }}
                    onFocus={(e) => {
                      e.target.style.borderColor = 'rgba(59, 130, 246, 0.6)';
                      e.target.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
                    }}
                    onBlur={(e) => {
                      e.target.style.borderColor = 'rgba(59, 130, 246, 0.3)';
                      e.target.style.backgroundColor = 'rgba(59, 130, 246, 0.05)';
                    }}
                  />

                    {locationSuggestions.end.length > 0 && (
                    <div style={{
                      position: 'absolute',
                      top: '56px',
                      left: 0,
                      right: 0,
                      backgroundColor: 'rgba(30, 41, 59, 0.95)',
                      border: '1px solid rgba(59, 130, 246, 0.3)',
                      borderRadius: '8px',
                      marginTop: '4px',
                      zIndex: 10000,
                      maxHeight: '200px',
                      overflowY: 'auto',
                      boxShadow: '0 8px 20px rgba(0,0,0,0.3)'
                    }}>
                      {locationSuggestions.end.map((loc, idx) => (
                        <div
                          key={idx}
                          onClick={() => selectLocation(loc, 'end')}
                          style={{
                            padding: '12px 16px',
                            borderBottom: idx < locationSuggestions.end.length - 1 ? '1px solid #333' : 'none',
                            cursor: 'pointer',
                            fontSize: '14px',
                            transition: 'background 0.2s'
                          }}
                          onMouseOver={(e) => e.target.style.backgroundColor = '#2A2A2A'}
                          onMouseOut={(e) => e.target.style.backgroundColor = '#0A0A0A'}
                        >
                          <div style={{ fontWeight: 'bold', marginBottom: '2px' }}>üìç {loc.name}</div>
                          <div style={{ fontSize: '12px', color: '#AAA' }}>{loc.fullName}</div>
                        </div>
                      ))}
                    </div>
                    )}
                </div>
              </div>

              {/* Status Messages */}
              {error && (
                <div style={{
                  backgroundColor: '#5D1F1F',
                  color: '#FF6B6B',
                  padding: '12px 16px',
                  borderRadius: '8px',
                  marginBottom: '16px',
                  fontSize: '14px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px'
                }}>
                  <span>‚ùå</span> {error}
                </div>
              )}

              {searching && (
                <div style={{
                  backgroundColor: '#1F3D5D',
                  color: '#64B5F6',
                  padding: '12px 16px',
                  borderRadius: '8px',
                  marginBottom: '16px',
                  fontSize: '14px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px'
                }}>
                  <span>‚è≥</span> Searching locations...
                </div>
              )}

              {/* Action Buttons */}
              <div style={{ display: 'flex', gap: '12px' }}>
                <button
                  onClick={() => setShowRouteModal(false)}
                  style={{
                    flex: 1,
                    padding: '14px',
                    backgroundColor: 'rgba(148, 163, 184, 0.1)',
                    color: '#CBD5E1',
                    border: '1px solid rgba(148, 163, 184, 0.2)',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    fontSize: '15px',
                    fontWeight: 'bold',
                    transition: 'all 0.2s'
                  }}
                  onMouseOver={(e) => {
                    e.target.style.backgroundColor = 'rgba(148, 163, 184, 0.15)';
                  }}
                  onMouseOut={(e) => {
                    e.target.style.backgroundColor = 'rgba(148, 163, 184, 0.1)';
                  }}
                >
                  Cancel
                </button>
                <button
                  onClick={applyRoute}
                  disabled={!startLocation || !endLocation}
                  style={{
                    flex: 2,
                    padding: '14px',
                    background: startLocation && endLocation ? 'linear-gradient(135deg, rgb(34, 197, 94), rgb(16, 185, 129))' : 'rgba(148, 163, 184, 0.2)',
                    color: '#FFF',
                    border: 'none',
                    borderRadius: '8px',
                    cursor: startLocation && endLocation ? 'pointer' : 'not-allowed',
                    fontSize: '15px',
                    fontWeight: 'bold',
                    transition: 'all 0.2s',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '8px'
                  }}
                  onMouseOver={(e) => {
                    if (startLocation && endLocation) {
                      e.target.style.transform = 'translateY(-2px)';
                      e.target.style.boxShadow = '0 6px 16px rgba(34, 197, 94, 0.3)';
                    }
                  }}
                  onMouseOut={(e) => {
                    if (startLocation && endLocation) {
                      e.target.style.transform = 'translateY(0)';
                      e.target.style.boxShadow = 'none';
                    }
                  }}
                >
                  <span>üó∫Ô∏è</span> Show Route with Potholes
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Control Panel - Only show in live tracking mode */}
      {!useRouteMode && (
        <div style={{
          backgroundColor: 'rgba(15, 23, 42, 0.6)',
          backdropFilter: 'blur(12px)',
          padding: '15px 20px',
          borderTop: '1px solid rgba(6, 182, 212, 0.1)',
          marginTop: '180px'
        }}>
          <div style={{ maxWidth: '1400px', margin: '0 auto', display: 'flex', gap: '20px', alignItems: 'center', flexWrap: 'wrap' }}>
            {/* Alert Radius Control */}
            <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
              <label style={{ fontSize: '14px', color: '#94A3B8' }}>Alert Radius:</label>
              <select
                value={alertRadius}
                onChange={(e) => setAlertRadius(Number(e.target.value))}
                style={{
                  padding: '8px 12px',
                  backgroundColor: '#333',
                  color: '#FFF',
                  border: '1px solid #555',
                  borderRadius: '4px',
                  fontSize: '14px',
                  cursor: 'pointer'
                }}
              >
                <option value={100}>100m</option>
                <option value={250}>250m</option>
                <option value={500}>500m</option>
                <option value={1000}>1000m (1km)</option>
                <option value={2000}>2000m (2km)</option>
              </select>
            </div>

            {/* Show Alert Zones Toggle */}
            <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer', fontSize: '14px' }}>
              <input
                type="checkbox"
                checked={showAlertZones}
                onChange={(e) => setShowAlertZones(e.target.checked)}
                style={{ cursor: 'pointer' }}
              />
              <span>Show Alert Zones</span>
            </label>

            {/* Sound Toggle */}
            <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer', fontSize: '14px', color: '#E2E8F0' }}>
              <input
                type="checkbox"
                checked={soundEnabled}
                onChange={(e) => setSoundEnabled(e.target.checked)}
                style={{ cursor: 'pointer' }}
              />
              <span>{soundEnabled ? 'üîä' : 'üîá'} Sound Alerts</span>
            </label>

            {/* Stats */}
            <div style={{ 
              marginLeft: 'auto', 
              display: 'flex', 
              gap: '15px', 
              fontSize: '13px',
              color: '#94A3B8'
            }}>
              <span>üìä Reports: <strong style={{ color: '#FFF' }}>{reports.length}</strong></span>
              <span>‚ö†Ô∏è Alerts: <strong style={{ color: '#FFA500' }}>{stats.alertsShown}</strong></span>
            </div>
          </div>
        </div>
      )}
      {/* END NAVBAR & CONTROLS SECTION */}

      {/* Map Container - Separate Section */}
      <div style={{ 
        flex: 1, 
        overflow: 'hidden',
        display: 'flex',
        flexDirection: 'column'
      }}>
        {/* STATUS BAR */}
        {isTracking && (
          <div style={{
            padding: '8px 15px',
            backgroundColor: 'rgba(26, 26, 26, 0.9)',
            borderBottom: '1px solid rgba(6, 182, 212, 0.2)',
            fontSize: '13px',
            color: '#AAA'
          }}>
            {error && `‚ùå ${error}`}
            {loading && '‚è≥ Loading pothole data...'}
            {isTracking && !error && (
              <span>
                üü¢ Live tracking active ‚Ä¢ 
                {location && ` üìç ${location.lat.toFixed(5)}, ${location.lon.toFixed(5)}`}
                {location?.accuracy && ` ‚Ä¢ Accuracy: ¬±${Math.round(location.accuracy)}m`}
                {location?.speed && location.speed > 0 && ` ‚Ä¢ Speed: ${(location.speed * 3.6).toFixed(1)} km/h`}
              </span>
            )}
          </div>
        )}

        {/* MAP DISPLAY */}
        <div style={{ 
          flex: 1, 
          overflow: 'hidden', 
          borderRadius: '0'
        }}>
          {useRouteMode ? (
          startLocation && endLocation ? (
            <RouteMap
              startLocation={startLocation}
              endLocation={endLocation}
              reports={reports}
              showAnalysis={showRouteAnalysis}
              onCloseAnalysis={() => setShowRouteAnalysis(false)}
            />
          ) : (
            <div style={{
              display: 'flex',
              justifyContent: 'center',
              alignItems: 'center',
              height: '100%',
              fontSize: '18px',
              color: '#AAA'
            }}>
              üìç Enter both starting location and destination to see the route with potholes
            </div>
          )
        ) : (
          !loading && (
            <PotholeAlertMap
              userLocation={location}
              reports={reports}
              alertRadius={alertRadius}
              showAlertZones={showAlertZones}
            />
          )
        )}
        
        {!useRouteMode && loading && (
          <div style={{
            display: 'flex',
            justifyContent: 'center',
            alignItems: 'center',
            height: '100%',
            fontSize: '18px',
            color: '#AAA'
          }}>
            Loading map and pothole data...
          </div>
        )}
      </div>
      {/* END MAP DISPLAY */}
      </div>
      {/* END MAP CONTAINER SECTION */}

      {/* ===== FOOTER & CONTROLS SECTION ===== */}
      <div style={{ flexShrink: 0, backgroundColor: '#0f172a', borderTop: '1px solid rgba(6, 182, 212, 0.1)' }}>
      {/* Live Tracking Controls - Only in live mode */}
      {!useRouteMode && (
        <div style={{
          backgroundColor: 'rgba(15, 23, 42, 0.9)',
          padding: '12px 20px',
          borderTop: '1px solid rgba(6, 182, 212, 0.2)',
          display: 'flex',
          gap: '10px',
          justifyContent: 'center',
          flexWrap: 'wrap',
          maxWidth: '500px',
          margin: '0 auto'
        }}>
          <button
            onClick={getCurrentLocation}
            disabled={isTracking}
            style={{
              padding: '10px 20px',
              backgroundColor: isTracking ? '#555' : '#4CAF50',
              color: '#FFF',
              border: 'none',
              borderRadius: '6px',
              cursor: isTracking ? 'not-allowed' : 'pointer',
              fontSize: '14px'
            }}
          >
            üìç Get Location
          </button>
          
          <button
            onClick={toggleTracking}
            style={{
              padding: '10px 20px',
              backgroundColor: isTracking ? '#F44336' : '#2196F3',
              color: '#FFF',
              border: 'none',
              borderRadius: '6px',
              cursor: 'pointer',
              fontSize: '14px',
              fontWeight: 'bold'
            }}
          >
            {isTracking ? '‚èπ Stop Tracking' : '‚ñ∂ Start Live Tracking'}
          </button>

          <button
            onClick={() => router.push('/test-alerts')}
            style={{
              padding: '10px 20px',
              backgroundColor: '#555',
              color: '#FFF',
              border: 'none',
              borderRadius: '6px',
              cursor: 'pointer',
              fontSize: '14px'
            }}
          >
            üëÅÔ∏è Test Alerts
          </button>
        </div>
      )}
      </div>
      {/* END FOOTER & CONTROLS SECTION */}
      </div>
      {/* END MAIN CONTAINER */}
    </div>
  )
}
